- name: Check app installed
  stat:
    path: /home/circleci/raisetech-live8-sample-app
  register: app_installed

- name: Set directory permissions
  ansible.builtin.file:
    path: /home/circleci/raisetech-live8-sample-app
    state: directory
    owner: ec2-user  # 適切な所有者に変更する
    group: ec2-user  # 適切なグループに変更する
    mode: '0755'    

# サンプルアプリケーションをclone
- name: Git clone sample app
  become_user: ec2-user
  ansible.builtin.git:
    repo: https://github.com/yuta-ushijima/raisetech-live8-sample-app.git
    dest: /home/circleci/raisetech-live8-sample-app
  when: not app_installed.stat.exists

# Rubyのアップグレード
- name: Upgrade Ruby to the latest version
  become_user: ec2-user
  ansible.builtin.command: rbenv install $(rbenv install -l | grep -v - | tail -1)
  when: not ruby_installed.stat.exists

- name: Set global Ruby version to the latest
  become_user: ec2-user
  ansible.builtin.command: rbenv global $(rbenv install -l | grep -v - | tail -1)
  when: not ruby_installed.stat.exists

- name: Reload rbenv
  shell: bash -lc "rbenv rehash"
  become_user: ec2-user
  when: not ruby_installed.stat.exists

- name: Install bundler gem
  become_user: ec2-user
  ansible.builtin.command: sudo gem install bundler -v 2.4.18

# unicornインストール
- name: bundle install
  shell: bash -lc "bundle install"
  args: 
    chdir: /home/circleci/raisetech-live8-sample-app/